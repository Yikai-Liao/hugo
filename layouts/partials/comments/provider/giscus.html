{{/* layouts/partials/comments/provider/giscus.html */}}
{{- if .Site.Params.comments.enabled -}}
  {{- with .Site.Params.comments.giscus -}}
    {{/* Use language from config, fallback to zh-CN */}}
    {{ $giscusLang := .lang | default "zh-CN" }}
    {{/* Use protocol-relative URLs for CSS paths */}}
    {{ $lightCssPath := "/css/giscus-light.css" }}
    {{ $darkCssPath := "/css/giscus-dark.css" }}
    {{ $giscusLightCss := $lightCssPath | absURL | replaceRE "^https?:" "" }}
    {{ $giscusDarkCss := $darkCssPath | absURL | replaceRE "^https?:" "" }}

    {{/* Determine the term to use for mapping. Prioritize slug, fallback to title */}}
    {{ $giscusTerm := $.Page.Slug | default $.Page.Title }}

    <div class="giscus" id="giscus-comments"></div>
    {{/* Giscus main script - Use protocol-relative URL for default theme */}}
    <script src="https://giscus.app/client.js"
            data-repo="{{ .repo }}"
            data-repo-id="{{ .repoID }}"
            data-category="{{ .category }}"
            data-category-id="{{ .categoryID }}"
            data-mapping="specific"
            data-term="{{ $giscusTerm }}"
            data-strict="{{ .strict | default "0" }}"
            data-reactions-enabled="{{ .reactionsEnabled | default "1" }}"
            data-emit-metadata="{{ .emitMetadata | default "0" }}"
            data-input-position="{{ .inputPosition | default "bottom" }}"
            data-theme="{{ $giscusLightCss }}" {{/* Default to protocol-relative light theme CSS URL */}}
            data-lang="{{ $giscusLang }}"
            data-loading="{{ .loading | default "lazy" }}"
            crossorigin="anonymous"
            async>
    </script>

    {{/* Giscus theme switching script - Use protocol-relative CSS URLs */}}
    <script>
      (function () {
        const themeAttribute = 'data-scheme'; // Theme attribute on <html> tag
        const GiscusTheme = {
          light: '{{ $giscusLightCss }}',
          dark: '{{ $giscusDarkCss }}'
        };

        function setGiscusTheme(themeUrl) {
            const iframe = document.querySelector("iframe.giscus-frame");
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ giscus: { setTheme: themeUrl } }, 'https://giscus.app');
            } else {
                 // console.warn('Giscus iframe not found or not ready for theme change.');
            }
        }

        const changeGiscusTheme = () => {
          try {
              const currentScheme = document.documentElement.getAttribute(themeAttribute);
              const targetThemeUrl = (currentScheme === 'dark') ? GiscusTheme.dark : GiscusTheme.light;
              // console.log(`[Giscus Theme] Setting theme based on data-scheme='${currentScheme}': ${targetThemeUrl}`); // Debug log
              setGiscusTheme(targetThemeUrl);
          } catch (e) {
              console.error("[Giscus Theme] Error changing theme URL:", e);
          }
        };

        // Immediately set the correct theme on script load
        setTimeout(changeGiscusTheme, 1);

        // Observe subsequent theme changes
        const observer = new MutationObserver((mutationsList) => {
          for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === themeAttribute) {
              // console.log("[Giscus Theme] Detected data-scheme change."); // Debug log
              changeGiscusTheme();
              break;
            }
          }
        });

        // Start observing
        try {
            observer.observe(document.documentElement, { attributes: true });
        } catch (e) {
            console.error("[Giscus Theme] Error observing theme changes:", e);
        }

        // Re-apply theme when Giscus iframe loads/sends a message
        window.addEventListener('message', event => {
          if (event.origin !== 'https://giscus.app') return;
          if (event.data && event.data.giscus) {
            // console.log("[Giscus Theme] Received message from Giscus, re-applying theme."); // Debug log
             changeGiscusTheme();
          }
        });

      })();
    </script>
    <noscript>Please enable JavaScript to view the comments powered by Giscus.</noscript>
  {{- end }}
{{- end }}
